name: Build YT-GT AI Studio Pake MSI

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-win:
    runs-on: windows-latest
    permissions:
      contents: read

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Install Node 22
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Clone Pake
        run: git clone https://github.com/tw93/pake.git _pake

      - name: Install Pake Dependencies
        working-directory: _pake
        run: npm install

      - name: Update Rust Dependencies
        working-directory: _pake/src-tauri
        run: cargo update

      # =========================================================================
      # CREATE YOUTUBE OPTIMIZATION SCRIPT
      # =========================================================================
      - name: Download GoodTube
        working-directory: _pake
        run: |
          curl -L "https://raw.githubusercontent.com/goodtube4u/goodtube/refs/heads/main/goodtube.js" -o goodtube.js

      - name: Create Optimization Script
        working-directory: _pake
        shell: pwsh
        run: |
          $script = @"
          
          // ============================================================================
          // PAKE YOUTUBE OPTIMIZER - LOW RESOURCE EDITION
          // ============================================================================
          (function() {
            'use strict';
            
            var PERF_CSS = [
              '#cinematics, #cinematics-container { display: none !important; }',
              'ytd-watch-flexy[theater] #player-container-inner::before { display: none !important; }',
              '.ytp-gradient-top, .ytp-gradient-bottom { display: none !important; }',
              '*, *::before, *::after { animation-duration: 0.01ms !important; transition-duration: 0.01ms !important; scroll-behavior: auto !important; }',
              'ytd-thumbnail #mouseover-overlay, ytd-thumbnail #hover-overlays, #video-preview-container { display: none !important; }',
              '#guide-content, #masthead-container, ytd-masthead { backdrop-filter: none !important; -webkit-backdrop-filter: none !important; background: #0f0f0f !important; }',
              '.ytp-cued-thumbnail-overlay-image, .ytp-videowall-still-image { filter: none !important; }',
              'ytd-rich-item-renderer, ytd-video-renderer { box-shadow: none !important; }',
              'ytd-miniplayer { display: none !important; }',
              'img.yt-core-image { image-rendering: auto; content-visibility: auto; }',
              '#guide-inner-content ytd-guide-section-renderer:nth-child(n+4) { display: none !important; }',
              'ytd-mealbar-promo-renderer, #masthead-ad, ytd-ad-slot-renderer, ytd-banner-promo-renderer { display: none !important; }',
              'ytd-promoted-sparkles-web-renderer, ytd-promoted-video-renderer, ytd-display-ad-renderer { display: none !important; }',
              '.ytp-ad-module, .video-ads, #player-ads, ytd-companion-slot-renderer { display: none !important; }',
              '.ytp-ce-element, .ytp-cards-teaser, .annotation { display: none !important; }',
              '#movie_player, .html5-video-container, video { will-change: auto !important; contain: layout style paint; }',
              '::-webkit-scrollbar { width: 8px; background: #181818; }',
              '::-webkit-scrollbar-thumb { background: #333; }'
            ].join(' ');
            
            function injectCSS() {
              if (document.getElementById('pake-perf-css')) return;
              var s = document.createElement('style');
              s.id = 'pake-perf-css';
              s.textContent = PERF_CSS;
              (document.head || document.documentElement).appendChild(s);
            }
            
            function setupLazyLoad() {
              document.querySelectorAll('img.yt-core-image').forEach(function(img) {
                img.loading = 'lazy';
                img.decoding = 'async';
              });
            }
            
            function stopPreviews() {
              var main = document.querySelector('#movie_player video');
              if (main) main.dataset.pakeMain = '1';
              document.querySelectorAll('video:not([data-pake-main])').forEach(function(v) {
                if (!v.closest('#movie_player')) {
                  v.pause();
                  v.src = '';
                }
              });
            }
            
            function blockTracking() {
              var blocked = ['doubleclick', 'googlesyndication', 'googleadservices', '/pagead/', '/ads/', 'log_event'];
              var origFetch = window.fetch;
              window.fetch = function(url) {
                if (typeof url === 'string') {
                  for (var i = 0; i < blocked.length; i++) {
                    if (url.indexOf(blocked[i]) !== -1) {
                      return Promise.resolve(new Response('', { status: 204 }));
                    }
                  }
                }
                return origFetch.apply(this, arguments);
              };
            }
            
            function optimizePlayer() {
              var p = document.getElementById('movie_player');
              if (!p) return;
              try {
                if (p.setPlaybackQualityRange) {
                  var q = p.getAvailableQualityLevels();
                  var current = p.getPlaybackQuality();
                  var highRes = ['hd1080','hd1440','hd2160','highres'];
                  if (q.indexOf('hd720') !== -1 && highRes.indexOf(current) !== -1) {
                    p.setPlaybackQualityRange('hd720', 'hd720');
                  }
                }
                if (p.unloadModule) p.unloadModule('annotations_module');
              } catch(e) {}
            }
            
            function cleanup() {
              var selectors = ['ytd-promoted-sparkles-web-renderer', 'ytd-promoted-video-renderer', 'ytd-display-ad-renderer', '#player-ads', '.ytp-ad-module'];
              selectors.forEach(function(s) {
                document.querySelectorAll(s).forEach(function(el) { el.remove(); });
              });
            }
            
            function init() {
              console.log('[Pake YT Optimizer] Starting...');
              injectCSS();
              setupLazyLoad();
              blockTracking();
              setTimeout(function() { stopPreviews(); optimizePlayer(); cleanup(); }, 1500);
              setInterval(stopPreviews, 3000);
              setInterval(optimizePlayer, 5000);
              setInterval(cleanup, 5000);
              setInterval(injectCSS, 2000);
              setInterval(setupLazyLoad, 3000);
              console.log('[Pake YT Optimizer] Active');
            }
            
            if (document.readyState === 'loading') {
              document.addEventListener('DOMContentLoaded', init);
            } else {
              init();
            }
            
            var lastUrl = location.href;
            setInterval(function() {
              if (location.href !== lastUrl) {
                lastUrl = location.href;
                setTimeout(init, 500);
              }
            }, 1000);
            
          })();
          "@
          
          Add-Content -Path goodtube.js -Value $script
          Write-Host "Optimization script created"

      # =========================================================================
      # PATCH RUST FOR WEBVIEW2 FLAGS
      # =========================================================================
      - name: Patch WebView2 Flags
        shell: pwsh
        run: |
          $mainRs = "_pake/src-tauri/src/main.rs"
          $libRs = "_pake/src-tauri/src/lib.rs"
          
          $flags = '--disable-features=msSmartScreenProtection,MediaRouter,Translate,BackForwardCache --enable-low-end-device-mode --disable-smooth-scrolling --disable-gpu-vsync --renderer-process-limit=2 --disable-backgrounding-occluded-windows --disable-renderer-backgrounding --js-flags=--max-old-space-size=256 --disable-background-networking'
          
          $envCode = @"
          
              // PAKE WEBVIEW2 FLAGS
              std::env::set_var("WEBVIEW2_ADDITIONAL_BROWSER_ARGUMENTS", "$flags");
          "@
          
          if (Test-Path $mainRs) {
            $content = Get-Content -Raw $mainRs
            if ($content -match 'fn\s+main\s*\(\s*\)\s*\{') {
              $content = $content -replace '(fn\s+main\s*\(\s*\)\s*\{)', "`$1$envCode"
              Set-Content -Path $mainRs -Value $content -Encoding UTF8
              Write-Host "Patched main.rs"
            }
          } elseif (Test-Path $libRs) {
            $content = Get-Content -Raw $libRs
            if ($content -match 'pub\s+fn\s+run\s*\(\s*\)') {
              $content = $content -replace '(pub\s+fn\s+run\s*\(\s*\)\s*\{)', "`$1$envCode"
              Set-Content -Path $libRs -Value $content -Encoding UTF8
              Write-Host "Patched lib.rs"
            }
          }

      # =========================================================================
      # REMOVE MENU BAR
      # =========================================================================
      - name: Remove Menu Bar
        shell: pwsh
        run: |
          $menuRs = "_pake/src-tauri/src/app/menu.rs"
          
          if (Test-Path $menuRs) {
            $emptyMenu = @"
          use tauri::{Menu, WindowMenuEvent, Wry};
          
          pub fn get_menu() -> Menu {
              Menu::new()
          }
          
          pub fn menu_event_handle(_event: WindowMenuEvent<Wry>) {}
          "@
            Set-Content -Path $menuRs -Value $emptyMenu -Encoding UTF8
            Write-Host "Replaced menu.rs with empty menu"
          }
          
          $mainRs = "_pake/src-tauri/src/main.rs"
          if (Test-Path $mainRs) {
            $content = Get-Content -Raw $mainRs
            $content = $content -replace '\.menu\([^)]+\)', ''
            Set-Content -Path $mainRs -Value $content -Encoding UTF8
            Write-Host "Removed .menu() calls"
          }

      # =========================================================================
      # BUILD
      # =========================================================================
      - name: Build Pake App
        working-directory: _pake
        shell: pwsh
        run: |
          $inject = Resolve-Path goodtube.js
          Write-Host "Inject script: $inject"
          
          npx pake https://www.youtube.com --name Youtube-GT --targets x86_64-pc-windows-msvc --inject $inject --width 1100 --height 650 --hide-title-bar

      # =========================================================================
      # UPLOAD
      # =========================================================================
      - name: Find and Rename MSI
        shell: pwsh
        run: |
          $msi = Get-ChildItem -Path _pake -Recurse -Filter "*.msi" | Select-Object -First 1
          if ($msi) {
            Copy-Item $msi.FullName Youtube-GT-x64.msi
            Write-Host "MSI ready: Youtube-GT-x64.msi"
          } else {
            Write-Host "MSI not found"
            Get-ChildItem -Path _pake -Recurse | Where-Object { $_.Extension -in '.msi','.exe' }
            exit 1
          }

      - name: Upload MSI
        uses: actions/upload-artifact@v4
        with:
          name: Youtube-GT-x64
          path: Youtube-GT-x64.msi
          if-no-files-found: error
