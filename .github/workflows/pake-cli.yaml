name: Build YT-GT AI Studio Pake MSI

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-win:
    runs-on: windows-latest
    permissions:
      contents: read

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Install Node 22
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Clone Pake
        run: git clone https://github.com/tw93/pake.git _pake

      - name: Install Pake Dependencies
        working-directory: _pake
        run: npm install

      - name: Update Rust Dependencies
        working-directory: _pake/src-tauri
        run: cargo update

      # =========================================================================
      # DEBUG
      # =========================================================================
      - name: Debug File Structure
        shell: pwsh
        run: |
          Write-Host "=== Rust files ==="
          Get-ChildItem -Path "_pake/src-tauri/src" -Recurse -Filter "*.rs" | ForEach-Object { Write-Host $_.FullName }

      # =========================================================================
      # DOWNLOAD GOODTUBE
      # =========================================================================
      - name: Download GoodTube
        working-directory: _pake
        run: curl -L "https://raw.githubusercontent.com/goodtube4u/goodtube/refs/heads/main/goodtube.js" -o goodtube.js

      # =========================================================================
      # CREATE OPTIMIZATION SCRIPT (Line by line to avoid YAML issues)
      # =========================================================================
      - name: Create Optimization Script
        working-directory: _pake
        shell: bash
        run: |
          cat >> goodtube.js << 'ENDSCRIPT'

          // PAKE YOUTUBE OPTIMIZER v2
          (function() {
            'use strict';
            
            function addStyles() {
              if (document.getElementById('pake-opt-css')) return;
              var css = document.createElement('style');
              css.id = 'pake-opt-css';
              css.textContent = 
                '#cinematics { display: none !important; }' +
                '#cinematics-container { display: none !important; }' +
                'ytd-thumbnail #mouseover-overlay { display: none !important; }' +
                'ytd-thumbnail #hover-overlays { display: none !important; }' +
                '#video-preview-container { display: none !important; }' +
                '.ytp-cued-thumbnail-overlay-image { filter: none !important; }' +
                '#guide-content { backdrop-filter: none !important; }' +
                '#masthead-container { backdrop-filter: none !important; }' +
                'ytd-ad-slot-renderer { display: none !important; }' +
                'ytd-mealbar-promo-renderer { display: none !important; }' +
                '#masthead-ad { display: none !important; }' +
                '.ytp-ad-module { display: none !important; }' +
                'ytd-miniplayer { display: none !important; }' +
                'img.yt-core-image { content-visibility: auto; }';
              
              if (document.head) {
                document.head.appendChild(css);
              }
            }
            
            function lazyImages() {
              var images = document.querySelectorAll('img.yt-core-image:not([loading])');
              for (var i = 0; i < images.length; i++) {
                images[i].loading = 'lazy';
                images[i].decoding = 'async';
              }
            }
            
            function init() {
              console.log('[Pake Optimizer] Starting');
              addStyles();
              lazyImages();
              setInterval(lazyImages, 5000);
              setInterval(addStyles, 3000);
            }
            
            if (document.readyState === 'loading') {
              document.addEventListener('DOMContentLoaded', init);
            } else {
              init();
            }
          })();
          ENDSCRIPT
          
          echo "Optimization script added"

      # =========================================================================
      # PATCH RUST TO REMOVE MENU
      # =========================================================================
      - name: Patch Rust Menu
        shell: bash
        run: |
          # Find and patch menu.rs if exists
          if [ -f "_pake/src-tauri/src/app/menu.rs" ]; then
            cat > "_pake/src-tauri/src/app/menu.rs" << 'EOF'
          use tauri::menu::Menu;
          use tauri::Wry;
          use tauri::AppHandle;

          pub fn get_menu(_app: &AppHandle) -> Option<Menu<Wry>> {
              None
          }
          EOF
            echo "Patched menu.rs"
          fi
          
          # Remove .menu() calls from main.rs
          if [ -f "_pake/src-tauri/src/main.rs" ]; then
            sed -i 's/\.menu([^)]*)//g' "_pake/src-tauri/src/main.rs"
            echo "Patched main.rs"
          fi
          
          # Remove .menu() calls from lib.rs
          if [ -f "_pake/src-tauri/src/lib.rs" ]; then
            sed -i 's/\.menu([^)]*)//g' "_pake/src-tauri/src/lib.rs"
            echo "Patched lib.rs"
          fi

      # =========================================================================
      # BUILD
      # =========================================================================
      - name: Build Pake App
        working-directory: _pake
        shell: bash
        env:
          WEBVIEW2_ADDITIONAL_BROWSER_ARGUMENTS: "--disable-smooth-scrolling --enable-low-end-device-mode --renderer-process-limit=2"
        run: |
          npx pake https://www.youtube.com \
            --name Youtube-GT \
            --targets x86_64-pc-windows-msvc \
            --inject ./goodtube.js \
            --width 1100 \
            --height 650 \
            --hide-title-bar

      # =========================================================================
      # UPLOAD
      # =========================================================================
      - name: Find and Rename MSI
        shell: pwsh
        run: |
          $msi = Get-ChildItem -Path _pake -Recurse -Filter "*.msi" | Select-Object -First 1
          if ($msi) {
            Copy-Item $msi.FullName Youtube-GT-x64.msi
            Write-Host "MSI ready: Youtube-GT-x64.msi"
          } else {
            Write-Host "MSI not found"
            Get-ChildItem -Path _pake -Recurse -Include *.msi,*.exe
            exit 1
          }

      - name: Upload MSI
        uses: actions/upload-artifact@v4
        with:
          name: Youtube-GT-x64
          path: Youtube-GT-x64.msi
          if-no-files-found: error
