name: Build YT-GT AI Studio Pake MSI

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-win:
    runs-on: windows-latest
    permissions:
      contents: read

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Install Node 22
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Clone Pake
        run: git clone https://github.com/tw93/pake.git _pake

      - name: Install Pake Dependencies
        working-directory: _pake
        run: npm install

      - name: Update Rust Dependencies
        working-directory: _pake/src-tauri
        run: cargo update

      # =========================================================================
      # DEBUG: Show file structure
      # =========================================================================
      - name: Debug File Structure
        shell: pwsh
        run: |
          Write-Host "=== Rust source files ==="
          Get-ChildItem -Path "_pake/src-tauri/src" -Recurse -Filter "*.rs" | ForEach-Object { Write-Host $_.FullName }
          Write-Host ""
          Write-Host "=== Tauri config files ==="
          Get-ChildItem -Path "_pake/src-tauri" -Filter "*.json" | ForEach-Object { Write-Host $_.FullName }
          Write-Host ""
          Write-Host "=== Cargo.toml ==="
          Get-Content "_pake/src-tauri/Cargo.toml" | Select-Object -First 30

      # =========================================================================
      # DOWNLOAD GOODTUBE
      # =========================================================================
      - name: Download GoodTube
        working-directory: _pake
        run: curl -L "https://raw.githubusercontent.com/goodtube4u/goodtube/refs/heads/main/goodtube.js" -o goodtube.js

      # =========================================================================
      # CREATE SAFE OPTIMIZATION SCRIPT (won't break video)
      # =========================================================================
      - name: Create Safe Optimization Script
        working-directory: _pake
        shell: pwsh
        run: |
          $script = @'

// ============================================================================
// PAKE YOUTUBE OPTIMIZER v2 - SAFE VERSION
// ============================================================================
(function() {
  'use strict';
  
  function addStyles() {
    if (document.getElementById('pake-opt-css')) return;
    var css = document.createElement('style');
    css.id = 'pake-opt-css';
    css.textContent = [
      '/* Disable ambient mode */',
      '#cinematics { display: none !important; visibility: hidden !important; opacity: 0 !important; }',
      '#cinematics-container { display: none !important; }',
      '',
      '/* Disable animations */',
      'ytd-thumbnail #mouseover-overlay { display: none !important; }',
      'ytd-thumbnail #hover-overlays { display: none !important; }',
      '#video-preview-container { display: none !important; }',
      '',
      '/* Remove blur effects */',
      '.ytp-cued-thumbnail-overlay-image { filter: none !important; }',
      '',
      '/* Simplify backgrounds */',
      '#guide-content { backdrop-filter: none !important; }',
      '#masthead-container { backdrop-filter: none !important; }',
      '',
      '/* Hide ads */',
      'ytd-ad-slot-renderer { display: none !important; }',
      'ytd-mealbar-promo-renderer { display: none !important; }',
      '#masthead-ad { display: none !important; }',
      '.ytp-ad-module { display: none !important; }',
      '',
      '/* Hide miniplayer */',
      'ytd-miniplayer { display: none !important; }',
      '',
      '/* Performance hints */',
      'img.yt-core-image { content-visibility: auto; }'
    ].join('\n');
    
    if (document.head) {
      document.head.appendChild(css);
    } else {
      document.addEventListener('DOMContentLoaded', function() {
        document.head.appendChild(css);
      });
    }
  }
  
  function lazyImages() {
    var images = document.querySelectorAll('img.yt-core-image:not([loading])');
    for (var i = 0; i < images.length; i++) {
      images[i].loading = 'lazy';
      images[i].decoding = 'async';
    }
  }
  
  function init() {
    console.log('[Pake Optimizer] Initializing...');
    addStyles();
    lazyImages();
    setInterval(lazyImages, 5000);
    setInterval(addStyles, 3000);
    console.log('[Pake Optimizer] Ready');
  }
  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();
'@
          Add-Content -Path goodtube.js -Value $script -Encoding UTF8
          Write-Host "Created safe optimization script"

      # =========================================================================
      # REMOVE MENU - Method 1: Patch Tauri Config
      # =========================================================================
      - name: Patch Tauri Config to Remove Menu
        shell: pwsh
        run: |
          $configPath = "_pake/src-tauri/tauri.conf.json"
          
          if (Test-Path $configPath) {
            $json = Get-Content -Raw $configPath | ConvertFrom-Json -Depth 20
            
            # Set menu to null/empty
            if ($json.tauri.PSObject.Properties['menu']) {
              $json.tauri.menu = $null
            }
            
            # Ensure decorations false and no menu
            if ($json.tauri.windows -and $json.tauri.windows.Count -gt 0) {
              $json.tauri.windows[0] | Add-Member -NotePropertyName "decorations" -NotePropertyValue $false -Force
            }
            
            $json | ConvertTo-Json -Depth 20 | Set-Content -Path $configPath -Encoding UTF8
            Write-Host "Patched tauri.conf.json"
            Get-Content $configPath | Select-Object -First 50
          } else {
            Write-Host "tauri.conf.json not found yet - will be created by pake"
          }

      # =========================================================================
      # REMOVE MENU - Method 2: Create custom build script
      # =========================================================================
      - name: Create Build Config Without Menu
        working-directory: _pake
        shell: pwsh
        run: |
          # Create pake.json config to control build
          $pakeConfig = @{
            url = "https://www.youtube.com"
            name = "Youtube-GT"
            width = 1100
            height = 650
            hide_title_bar = $true
            menu = @{}
          }
          
          $pakeConfig | ConvertTo-Json -Depth 10 | Set-Content -Path "pake-config.json" -Encoding UTF8
          Write-Host "Created pake-config.json"

      # =========================================================================
      # PATCH RUST SOURCE TO DISABLE MENU
      # =========================================================================
      - name: Patch Rust to Remove Menu
        shell: pwsh
        run: |
          # Find all Rust files
          $rustFiles = Get-ChildItem -Path "_pake/src-tauri/src" -Recurse -Filter "*.rs"
          
          foreach ($file in $rustFiles) {
            $content = Get-Content -Raw $file.FullName
            $modified = $false
            
            # Remove menu usage
            if ($content -match '\.menu\(') {
              $content = $content -replace '\.menu\([^)]*\)', ''
              $content = $content -replace '\.menu\([^)]*\([^)]*\)[^)]*\)', ''
              $modified = $true
              Write-Host "Removed .menu() from $($file.Name)"
            }
            
            # Remove menu imports
            if ($content -match 'use.*menu') {
              $content = $content -replace 'use\s+crate::app::menu[^;]*;', '// menu disabled'
              $content = $content -replace 'mod\s+menu;', '// mod menu;'
              $modified = $true
              Write-Host "Removed menu imports from $($file.Name)"
            }
            
            if ($modified) {
              Set-Content -Path $file.FullName -Value $content -Encoding UTF8
            }
          }
          
          # Check for menu.rs and empty it
          $menuRs = "_pake/src-tauri/src/app/menu.rs"
          if (Test-Path $menuRs) {
            $emptyMenu = @"
use tauri::menu::Menu;
use tauri::Wry;
use tauri::AppHandle;

pub fn get_menu(_app: &AppHandle) -> Option<Menu<Wry>> {
    None
}
"@
            Set-Content -Path $menuRs -Value $emptyMenu -Encoding UTF8
            Write-Host "Emptied menu.rs"
          }

      # =========================================================================
      # SET WEBVIEW2 FLAGS VIA ENVIRONMENT
      # =========================================================================
      - name: Set WebView2 Environment
        shell: pwsh
        run: |
          $flags = "--disable-smooth-scrolling --enable-low-end-device-mode --renderer-process-limit=2 --disable-backgrounding-occluded-windows --disable-gpu-vsync"
          echo "WEBVIEW2_ADDITIONAL_BROWSER_ARGUMENTS=$flags" >> $env:GITHUB_ENV
          Write-Host "Set WebView2 flags: $flags"

      # =========================================================================
      # BUILD
      # =========================================================================
      - name: Build Pake App
        working-directory: _pake
        shell: pwsh
        env:
          WEBVIEW2_ADDITIONAL_BROWSER_ARGUMENTS: "--disable-smooth-scrolling --enable-low-end-device-mode --renderer-process-limit=2 --disable-backgrounding-occluded-windows"
        run: |
          $inject = Resolve-Path goodtube.js
          Write-Host "Building with inject: $inject"
          
          npx pake https://www.youtube.com --name Youtube-GT --targets x86_64-pc-windows-msvc --inject $inject --width 1100 --height 650 --hide-title-bar --no-menu

      # =========================================================================
      # FALLBACK BUILD (if --no-menu not supported)
      # =========================================================================
      - name: Fallback Build Without --no-menu
        if: failure()
        working-directory: _pake
        shell: pwsh
        run: |
          $inject = Resolve-Path goodtube.js
          npx pake https://www.youtube.com --name Youtube-GT --targets x86_64-pc-windows-msvc --inject $inject --width 1100 --height 650 --hide-title-bar

      # =========================================================================
      # UPLOAD
      # =========================================================================
      - name: Find and Rename MSI
        shell: pwsh
        run: |
          $msi = Get-ChildItem -Path _pake -Recurse -Filter "*.msi" | Select-Object -First 1
          if ($msi) {
            Copy-Item $msi.FullName Youtube-GT-x64.msi
            $size = [math]::Round($msi.Length/1MB, 2)
            Write-Host "MSI ready: Youtube-GT-x64.msi ($size MB)"
          } else {
            Write-Host "=== Looking for build output ==="
            Get-ChildItem -Path "_pake" -Recurse | Where-Object { $_.Extension -match '\.(msi|exe)$' }
            exit 1
          }

      - name: Upload MSI
        uses: actions/upload-artifact@v4
        with:
          name: Youtube-GT-x64
          path: Youtube-GT-x64.msi
          if-no-files-found: error
