name: Build NotebookLM Desktop MSI

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-win:
    runs-on: windows-latest
    permissions:
      contents: read

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Install Node 22
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Clone Pake
        run: git clone https://github.com/tw93/pake.git _pake

      - name: Install Pake Dependencies
        working-directory: _pake
        run: npm install

      - name: Update Rust Dependencies
        working-directory: _pake/src-tauri
        run: cargo update

      # =========================================================================
      # 1. CREATE NOTEBOOKLM OPTIMIZATION SCRIPT
      # =========================================================================
      - name: Create Optimization Script
        working-directory: _pake
        shell: bash
        run: |
          cat >> notebooklm-opt.js << 'ENDSCRIPT'
          (function () {
            // NOTEBOOKLM DESKTOP OPTIMIZER
            // CSS: Cosmetic cleanups only. 
            const css = `
              body { -webkit-font-smoothing: antialiased !important; }
              ::-webkit-scrollbar { width: 8px; height: 8px; }
              ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }
            `;
            const style = document.createElement('style');
            style.id = 'notebooklm-lite-style';
            style.textContent = css;
            document.head.appendChild(style);
            console.log('[NotebookLM Desktop] Optimizations loaded');
          })();
          ENDSCRIPT

      # =========================================================================
      # 2. PATCH RUST (LOGIC & CONFIG) - SHORT-CIRCUIT STRATEGY
      # =========================================================================
      - name: Patch Rust Logic (Node.js)
        working-directory: _pake
        shell: bash
        run: |
          # Node script to inject a 'short-circuit' allowing Google domains immediately
          node -e "
          const fs = require('fs');
          const path = require('path');
          
          // Helper: Recursive file search
          function findRecursive(dir, term) {
            let results = [];
            const list = fs.readdirSync(dir);
            for (const file of list) {
              const filePath = path.join(dir, file);
              const stat = fs.statSync(filePath);
              if (stat && stat.isDirectory()) {
                results = results.concat(findRecursive(filePath, term));
              } else if (file.endsWith('.rs')) {
                const content = fs.readFileSync(filePath, 'utf8');
                if (content.includes(term)) {
                  results.push(filePath);
                }
              }
            }
            return results;
          }

          // 1. Locate the correct file (Recursive Search)
          const searchDir = 'src-tauri/src';
          console.log(\`Searching recursively in \${searchDir}...\`);
          
          let targetFiles = findRecursive(searchDir, 'on_navigation');
          
          if (targetFiles.length === 0) {
            console.error('CRITICAL: Could not find on_navigation logic.');
            // Fallback: Try main.rs and lib.rs directly if search fails?
            // process.exit(1); 
          } else {
            const targetFile = targetFiles[0]; 
            console.log(\`Patching target file: \${targetFile}\`);
            let content = fs.readFileSync(targetFile, 'utf8');

            // 2. Short-Circuit Injection Strategy
            // We find the start of the closure: .on_navigation(move |url| {
            // And inject: if url.as_str().contains(\"google\") { return true; }
            
            // Regex explanation:
            // \.on_navigation\s*\(   -> match function call
            // (?:move\s*)?           -> optional 'move' keyword
            // \|([^|]+)\|            -> capture the variable name (e.g., 'url')
            // \s*\{                  -> start of block
            
            const regex = /\.on_navigation\(\s*(?:move\s*)?\|([^|]+)\|\s*\{/g;
            
            if (regex.test(content)) {
                content = content.replace(regex, (match, varName) => {
                    console.log(\`Injecting Google whitelist for variable: \${varName}\`);
                    // The Injection:
                    // NOTE: Escaped quotes (\"google\") to prevent Bash from stripping them.
                    return \`\${match} 
                    // [PATCH] Allow Google Auth Redirects
                    if \${varName}.as_str().contains(\"google\") || \${varName}.as_str().contains(\"gstatic\") { 
                        return true; 
                    }
                    \`;
                });
                fs.writeFileSync(targetFile, content);
                console.log('SUCCESS: Navigation logic patched via short-circuit.');
            } else {
                console.error('WARNING: Regex did not match on_navigation pattern. Manual inspection required.');
                // Dump snippet for debugging if this fails again
                const idx = content.indexOf('on_navigation');
                if (idx !== -1) console.log(content.substring(idx, idx + 200));
            }
          }

          // 3. Patch Cargo.toml for size (Safe Replace)
          const cargoPath = 'src-tauri/Cargo.toml';
          if (fs.existsSync(cargoPath)) {
            let cargo = fs.readFileSync(cargoPath, 'utf8');
            cargo = cargo.replace(/\[profile\.release\][\s\S]*?(?=(\[|$))/g, '');
            const profile = \`
          [profile.release]
          opt-level = 'z'
          lto = true
          codegen-units = 1
          panic = 'abort'
          strip = true
          \`;
            fs.writeFileSync(cargoPath, cargo.trim() + '\\n' + profile);
            console.log('Cargo.toml optimized.');
          }
          "

          # 4. Remove Menu (Cosmetic)
          if [ -f "src-tauri/src/app/menu.rs" ]; then
            cat > "src-tauri/src/app/menu.rs" << 'EOF'
          use tauri::menu::Menu;
          use tauri::Wry;
          use tauri::AppHandle;
          pub fn get_menu(_app: &AppHandle) -> Option<Menu<Wry>> { None }
          EOF
          fi
          sed -i 's/\.menu([^)]*)//g' "src-tauri/src/main.rs" 2>/dev/null || true
          sed -i 's/\.menu([^)]*)//g' "src-tauri/src/lib.rs" 2>/dev/null || true

      # =========================================================================
      # 3. BUILD
      # =========================================================================
      - name: Build NotebookLM App
        working-directory: _pake
        shell: bash
        run: |
          npx pake https://notebooklm.google/ \
            --name NotebookLM-Desktop \
            --targets x86_64-pc-windows-msvc \
            --inject ./notebooklm-opt.js \
            --width 1200 \
            --height 900 \
            --hide-title-bar \
            --user-agent "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36 Edg/120.0.0.0"

      # =========================================================================
      # 4. UPLOAD ARTIFACT
      # =========================================================================
      - name: Find and Rename MSI
        shell: pwsh
        run: |
          $msi = Get-ChildItem -Path _pake -Recurse -Filter "*.msi" | Select-Object -First 1
          if ($msi) {
            Copy-Item $msi.FullName NotebookLM-Desktop-x64.msi
            Write-Host "MSI ready: NotebookLM-Desktop-x64.msi"
          } else {
            Write-Host "MSI not found"
            Get-ChildItem -Path _pake -Recurse -Include *.msi,*.exe
            exit 1
          }

      - name: Upload MSI
        uses: actions/upload-artifact@v4
        with:
          name: NotebookLM-Desktop-x64
          path: NotebookLM-Desktop-x64.msi
          if-no-files-found: error
