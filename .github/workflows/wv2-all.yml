name: Build Copilot Safe Pake MSI

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-win:
    runs-on: windows-latest
    permissions:
      contents: read

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Install Node 22
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Clone Pake
        run: git clone https://github.com/tw93/pake.git _pake

      - name: Install Pake Dependencies
        working-directory: _pake
        run: npm install

      - name: Update Rust Dependencies
        working-directory: _pake/src-tauri
        run: cargo update

      # =========================================================================
      # 1. CREATE SAFE OPTIMIZATION SCRIPT (Fixes Login Issues)
      # =========================================================================
      - name: Create Optimization Script
        working-directory: _pake
        shell: bash
        run: |
          cat >> copilot-safe.js << 'ENDSCRIPT'
          (function() {
            // SAFE COPILOT OPTIMIZER
            // Purpose: Disable ONLY expensive visual effects without breaking layout/fonts
            const css = `
              /* Disable blur effects on the main container only (saves GPU) */
              .cib-serp-main, #app {
                backdrop-filter: none !important;
                -webkit-backdrop-filter: none !important;
              }
              /* Disable smooth scrolling for snappier feel */
              * {
                scroll-behavior: auto !important;
              }
              /* Do NOT disable transitions globally - it breaks MS Login animations */
            `;
            const style = document.createElement('style');
            style.textContent = css;
            document.head.appendChild(style);
            
            console.log('[Copilot Safe] Optimizations Loaded');
          })();
          ENDSCRIPT

      # =========================================================================
      # 2. PATCH RUST (Binary Size Optimization + Menu Removal)
      # =========================================================================
      - name: Optimize Rust Profile & Remove Menu
        working-directory: _pake
        shell: bash
        run: |
          # 1. Append size optimizations to Cargo.toml
          cat >> src-tauri/Cargo.toml <<EOF
          
          [profile.release]
          opt-level = "z"     # Optimize for size
          lto = true          # Link Time Optimization
          codegen-units = 1   # Slow build, fast/small binary
          panic = "abort"     # Remove panic unwinding
          strip = true        # Strip symbols
          EOF

          # 2. Patch menu.rs to REMOVE the top menu bar completely
          # We overwrite the file to force it to return None
          mkdir -p src-tauri/src/app
          cat > "src-tauri/src/app/menu.rs" << 'EOF'
          use tauri::menu::Menu;
          use tauri::Wry;
          use tauri::AppHandle;

          pub fn get_menu(_app: &AppHandle) -> Option<Menu<Wry>> {
              // Return None to disable the menu bar
              None
          }
          EOF
          
          # 3. Patch main.rs to ensure the menu is actually disabled
          # We look for the line that attaches the menu and comment it out or remove it
          if [ -f "src-tauri/src/main.rs" ]; then
             sed -i 's/\.menu(app_menu)//g' "src-tauri/src/main.rs"
             sed -i 's/\.menu(menu)//g' "src-tauri/src/main.rs"
          fi

      # =========================================================================
      # 3. BUILD WITH SAFE FLAGS (No Process Limit)
      # =========================================================================
      - name: Build Copilot App
        working-directory: _pake
        shell: bash
        env:
          # CRITICAL: Removed "renderer-process-limit" and "low-end-device-mode"
          # Added "Edg/" User-Agent so Microsoft recognizes the browser
          WEBVIEW2_ADDITIONAL_BROWSER_ARGUMENTS: >-
            --disable-smooth-scrolling
            --disable-background-timer-throttling
            --disable-features=Translate,BackForwardCache,msSmartScreenProtection
        run: |
          npx pake https://copilot.microsoft.com \
            --name Copilot-Lite \
            --targets x86_64-pc-windows-msvc \
            --inject ./copilot-safe.js \
            --width 1100 \
            --height 750 \
            --hide-title-bar \
            --user-agent "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36 Edg/120.0.0.0"

      # =========================================================================
      # 4. UPLOAD ARTIFACT
      # =========================================================================
      - name: Find and Rename MSI
        shell: pwsh
        run: |
          $msi = Get-ChildItem -Path _pake -Recurse -Filter "*.msi" | Select-Object -First 1
          if ($msi) {
            Copy-Item $msi.FullName Copilot-Lite-x64.msi
            Write-Host "MSI ready: Copilot-Safe-x64.msi"
          } else {
            Write-Host "MSI not found"
            Get-ChildItem -Path _pake -Recurse -Include *.msi,*.exe
            exit 1
          }

      - name: Upload MSI
        uses: actions/upload-artifact@v4
        with:
          name: Copilot-Lite-x64
          path: Copilot-Lite-x64.msi
          if-no-files-found: error





          
