name: Build NotebookLM Desktop MSI

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-win:
    runs-on: windows-latest
    permissions:
      contents: read

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Install Node 22
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Clone Pake
        run: git clone https://github.com/tw93/pake.git _pake

      - name: Install Pake Dependencies
        working-directory: _pake
        run: npm install

      - name: Update Rust Dependencies
        working-directory: _pake/src-tauri
        run: cargo update

      # =========================================================================
      # 1. CREATE NOTEBOOKLM OPTIMIZATION SCRIPT
      # =========================================================================
      - name: Create Optimization Script
        working-directory: _pake
        shell: bash
        run: |
          cat >> notebooklm-opt.js << 'ENDSCRIPT'
          (function () {
            // NOTEBOOKLM DESKTOP OPTIMIZER (Windows / WebView2)
            // Goal: minimize GPU, CPU, RAM usage for text-heavy workflows

            /* ===============================
               CSS HARD OPTIMIZATION
            =============================== */
            const css = `
              /* Disable costly effects */
              * {
                backdrop-filter: none !important;
                -webkit-backdrop-filter: none !important;
                filter: none !important;
              }

              /* Disable animations for snap-feel */
              *, *::before, *::after {
                animation: none !important;
                transition: none !important;
                scroll-behavior: auto !important;
              }

              /* Reduce rendering cost */
              * {
                box-shadow: none !important;
                text-shadow: none !important;
              }

              body {
                text-rendering: optimizeSpeed !important;
                -webkit-font-smoothing: antialiased !important;
              }

              /* Lazy load media */
              img, video {
                content-visibility: auto;
                contain-intrinsic-size: 300px 300px;
                decoding: async;
              }
            `;

            const style = document.createElement('style');
            style.id = 'notebooklm-lite-style';
            style.textContent = css;
            document.head.appendChild(style);

            /* ===============================
               JS RUNTIME OPTIMIZATION
            =============================== */

            const noop = () => {};

            // Throttle animations
            window.requestAnimationFrame = function (cb) {
              return setTimeout(cb, 1000 / 30); // Cap at 30fps for UI
            };

            // Aggressive Garbage Collection trigger (if available in WebView2 context)
            if (window.gc) {
              setInterval(() => {
                try { window.gc(); } catch {}
              }, 60000);
            }

            // Persistence observer to ensure styles remain applied after hydration
            const mo = new MutationObserver(() => {
              if (!document.getElementById('notebooklm-lite-style')) {
                document.head.appendChild(style);
              }
            });

            mo.observe(document.documentElement, {
              childList: true,
              subtree: true
            });

            console.log('[NotebookLM Desktop] Optimizations loaded');
          })();
          ENDSCRIPT

          echo "Optimization script created: notebooklm-opt.js"

      # =========================================================================
      # 2. PATCH RUST (REMOVE MENU + BINARY SIZE OPTIMIZATION)
      # =========================================================================
      - name: Optimize Rust Profile & Remove Menu
        working-directory: _pake
        shell: bash
        run: |
          # Append aggressive optimization flags to Cargo.toml
          cat >> src-tauri/Cargo.toml <<EOF

          [profile.release]
          opt-level = "z"
          lto = true
          codegen-units = 1
          panic = "abort"
          strip = true
          EOF

          # Remove default menu logic to save space and reduce clutter
          if [ -f "src-tauri/src/app/menu.rs" ]; then
            cat > "src-tauri/src/app/menu.rs" << 'EOF'
          use tauri::menu::Menu;
          use tauri::Wry;
          use tauri::AppHandle;

          pub fn get_menu(_app: &AppHandle) -> Option<Menu<Wry>> {
              None
          }
          EOF
          fi

          # Clean up references to menu in main files
          if [ -f "src-tauri/src/main.rs" ]; then
            sed -i 's/\.menu([^)]*)//g' "src-tauri/src/main.rs"
          fi

          if [ -f "src-tauri/src/lib.rs" ]; then
            sed -i 's/\.menu([^)]*)//g' "src-tauri/src/lib.rs"
          fi

      # =========================================================================
      # 3. BUILD WITH MEMORY FLAGS
      # =========================================================================
      - name: Build NotebookLM App
        working-directory: _pake
        shell: bash
        env:
          # Force WebView2 into a constrained resource mode
          WEBVIEW2_ADDITIONAL_BROWSER_ARGUMENTS: >-
            --renderer-process-limit=1
            --enable-low-end-device-mode
            --disable-smooth-scrolling
            --disable-background-timer-throttling
            --disable-features=msWebOOUI,msPdfOOUI,msSmartScreenProtection,Translate,BackForwardCache
        run: |
          # UA Updated to Chrome 124 to ensure Google Auth compatibility
          npx pake https://notebooklm.google/ \
            --name NotebookLM-Desktop \
            --targets x86_64-pc-windows-msvc \
            --inject ./notebooklm-opt.js \
            --width 1200 \
            --height 800 \
            --hide-title-bar \
            --user-agent "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/124.0.0.0 Safari/537.36"

      # =========================================================================
      # 4. UPLOAD ARTIFACT
      # =========================================================================
      - name: Find and Rename MSI
        shell: pwsh
        run: |
          $msi = Get-ChildItem -Path _pake -Recurse -Filter "*.msi" | Select-Object -First 1
          if ($msi) {
            Copy-Item $msi.FullName NotebookLM-Desktop-x64.msi
            Write-Host "MSI ready: NotebookLM-Desktop-x64.msi"
          } else {
            Write-Host "MSI not found"
            Get-ChildItem -Path _pake -Recurse -Include *.msi,*.exe
            exit 1
          }

      - name: Upload MSI
        uses: actions/upload-artifact@v4
        with:
          name: NotebookLM-Desktop-x64
          path: NotebookLM-Desktop-x64.msi
          if-no-files-found: error
