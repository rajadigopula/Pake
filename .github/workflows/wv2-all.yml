name: Build NotebookLM Desktop MSI

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-win:
    runs-on: windows-latest
    permissions:
      contents: read

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Install Node 22
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Clone Pake
        run: git clone https://github.com/tw93/pake.git _pake

      - name: Install Pake Dependencies
        working-directory: _pake
        run: npm install

      - name: Update Rust Dependencies
        working-directory: _pake/src-tauri
        run: cargo update

      # =========================================================================
      # 1. CREATE NOTEBOOKLM OPTIMIZATION SCRIPT
      # =========================================================================
      - name: Create Optimization Script
        working-directory: _pake
        shell: bash
        run: |
          cat >> notebooklm-opt.js << 'ENDSCRIPT'
          (function () {
            // NOTEBOOKLM DESKTOP OPTIMIZER (Windows / WebView2)
            
            // CSS: Cosmetic cleanups only. 
            // Removed aggressive rendering blocks that might hide auth popups.
            const css = `
              body {
                -webkit-font-smoothing: antialiased !important;
              }
              /* Ensure scrollbars are visible for agreement texts */
              ::-webkit-scrollbar {
                width: 8px;
                height: 8px;
              }
              ::-webkit-scrollbar-thumb {
                background: #ccc;
                border-radius: 4px;
              }
            `;

            const style = document.createElement('style');
            style.id = 'notebooklm-lite-style';
            style.textContent = css;
            document.head.appendChild(style);

            console.log('[NotebookLM Desktop] UI Optimizations loaded');
          })();
          ENDSCRIPT

      # =========================================================================
      # 2. PATCH RUST (LOGIC & CONFIG)
      # =========================================================================
      - name: Patch Rust Logic
        working-directory: _pake
        shell: bash
        run: |
          # 1. Apply Deterministic Profile (Binary Size) via Node
          node -e "
            const fs = require('fs');
            const path = 'src-tauri/Cargo.toml';
            let content = fs.readFileSync(path, 'utf8');
            content = content.replace(/\[profile\.release\][\s\S]*?(?=(\[|$))/g, '');
            const newProfile = \`
          [profile.release]
          opt-level = 'z'
          lto = true
          codegen-units = 1
          panic = 'abort'
          strip = true
          \`;
            fs.writeFileSync(path, content.trim() + '\n' + newProfile);
            console.log('Cargo.toml patched.');
          "

          # 2. Remove Menu (Cosmetic)
          if [ -f "src-tauri/src/app/menu.rs" ]; then
            cat > "src-tauri/src/app/menu.rs" << 'EOF'
          use tauri::menu::Menu;
          use tauri::Wry;
          use tauri::AppHandle;
          pub fn get_menu(_app: &AppHandle) -> Option<Menu<Wry>> { None }
          EOF
          fi
          # Clean up menu refs
          sed -i 's/\.menu([^)]*)//g' "src-tauri/src/main.rs" 2>/dev/null || true
          sed -i 's/\.menu([^)]*)//g' "src-tauri/src/lib.rs" 2>/dev/null || true

          # 3. CRITICAL: PATCH NAVIGATION LOGIC FOR GOOGLE AUTH
          # Pake attempts to open external domains in system browser. 
          # We must whitelist 'google.com' to stay inside the WebView.
          
          # Fix: Use direct grep instead of xargs to prevent exit code 123 if not found.
          # We use '|| true' to ensure the step continues even if grep fails.
          TARGET_FILE=$(grep -lR "on_navigation" src-tauri/src | head -n 1 || true)
          
          if [ -z "$TARGET_FILE" ]; then
             echo "WARNING: Could not find navigation handler. Auth might fail."
          else
             echo "Patching navigation handler in $TARGET_FILE"
             
             # Fix: Escape ampersands (\&) in replacement string so sed treats them as literals
             # instead of backreferences to the matched string.
             # We look for the condition that triggers external browser opening.
             sed -i 's/if.*host != target_host.*/if host != target_host \&\& !url.as_str().contains("google.com") \&\& !url.as_str().contains("googleusercontent.com")/' "$TARGET_FILE"
          fi

      # =========================================================================
      # 3. BUILD (NO RESTRICTIVE FLAGS)
      # =========================================================================
      - name: Build NotebookLM App
        working-directory: _pake
        shell: bash
        # Removed WEBVIEW2_ADDITIONAL_BROWSER_ARGUMENTS entirely.
        # This restores multi-process rendering required for Auth popups.
        run: |
          npx pake https://notebooklm.google/ \
            --name NotebookLM-Desktop \
            --targets x86_64-pc-windows-msvc \
            --inject ./notebooklm-opt.js \
            --width 1200 \
            --height 900 \
            --hide-title-bar \
            --user-agent "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36 Edg/120.0.0.0"

      # =========================================================================
      # 4. UPLOAD ARTIFACT
      # =========================================================================
      - name: Find and Rename MSI
        shell: pwsh
        run: |
          $msi = Get-ChildItem -Path _pake -Recurse -Filter "*.msi" | Select-Object -First 1
          if ($msi) {
            Copy-Item $msi.FullName NotebookLM-Desktop-x64.msi
            Write-Host "MSI ready: NotebookLM-Desktop-x64.msi"
          } else {
            Write-Host "MSI not found"
            Get-ChildItem -Path _pake -Recurse -Include *.msi,*.exe
            exit 1
          }

      - name: Upload MSI
        uses: actions/upload-artifact@v4
        with:
          name: NotebookLM-Desktop-x64
          path: NotebookLM-Desktop-x64.msi
          if-no-files-found: error
